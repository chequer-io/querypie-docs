---
title: 'AWS EKS環境でインストール'
---

import { Callout } from 'nextra/components'

# AWS EKS環境でインストール

### 1. 概要

#### 1.1 目的

* AWS EKSクラスタにQueryPieをインストールし、構成する全体過程案内
* 安定的な運用のための設定ガイド提供

#### 1.2 対象読者

* Kubernetes基本概念（Pod、Service、Deploymentなど）を理解しているエンジニア
* AWS EKS使用経験があるエンジニア

#### 1.3 予想所要時間

* 全体インストール過程：約1時間
* 環境構成：15分
* 基本コンポーネント（MySQL、Redis）インストール：15分
* QueryPieインストール：20分
* インストール検証および初期設定：10分

### 2. 事前要件

#### 2.1 インフラ要件

* EKSクラスタ
    * 推奨ノード仕様：m7i.xlarge（4 vCPU、16GB RAM）
    * Kubernetesバージョン：1.24以上
    * 必要ノード数：最小1個（Production環境は3個以上推奨）

#### 2.2 ローカル環境準備事項

AWS CLIインストールおよび構成
```bash
brew install awscli
aws configure  # Requires Access Key and Secret Key
```

kubectlインストール
```bash
brew install kubectl
```

Helmインストール（バージョン3.10.0以上必須）
```bash
brew install helm
```

選択的ツールインストール（推奨）
```bash
brew install kubectx  # Context switching tool
brew install fzf      # Command-line fuzzy finder
```

#### 2.3 アクセス権限要件

Container Registryアクセス権限

* Docker Hub：認証なしで公開イメージ使用可能（`docker.io/querypie`）
* Harbor：別途アカウント情報必要（`harbor.chequer.io`）
    * アカウント情報（Username/Password）
    * QueryPieイメージアクセス権限

#### 2.4 ネットワーク要件

* インターネット接続（イメージダウンロード用）
* EKSクラスタアクセス可能なネットワーク環境
* LoadBalancer使用可能な環境（Ingress構成用）

### 3. 基本コンポーネントインストール

始める前にQueryPieをインストールするためにnamespacesを作成します。
```
kubectl create namespace querypie
```

#### 3.1 MetaDB(MySQL)インストール

MySQLはQueryPieのメタデータを保存するデータベースとして使用されます。

##### 3.1.1 Persistent Volume生成

以下の内容で`pv.yml`ファイルを生成します。
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: local-pv
  labels:
    app: mysql
spec:
  capacity:
    storage: 50Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: /var/lib/mysql
    type: DirectoryOrCreate
```

PVを生成します。
```bash
kubectl apply -f pv.yml
```

##### 3.1.2 MySQL StatefulSet配布

以下の内容で`mysql.yml`ファイルを生成します。`MYSQL_PASSWORD`のパスワードは顧客社のポリシーに従って異なる値を指定します。
```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
  namespace: querypie
spec:
  selector:
    matchLabels:
      app: mysql
  serviceName: mysql
  replicas: 1
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
        - name: mysql
          image: mysql:8.0
          env:
            - name: MYSQL_ROOT_PASSWORD
              value: querypie
            - name: MYSQL_DATABASE
              value: querypie
            - name: MYSQL_USER
              value: querypie
            - name: MYSQL_PASSWORD
              value: "{your-mysql-password}"
          resources:
            requests:
              cpu: "0.5"
              memory: "2Gi"
          ports:
            - containerPort: 3306
              name: mysql
          volumeMounts:
            - name: data
              mountPath: /var/lib/mysql
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 50Gi
        storageClassName: ""
        selector:
          matchLabels:
            app: mysql
---
apiVersion: v1
kind: Service
metadata:
  name: mysql
  namespace: querypie
  labels:
    app: mysql
spec:
  type: ClusterIP
  selector:
    app: mysql
  ports:
    - port: 3306
      targetPort: 3306
      protocol: TCP
      name: mysql
```

MySQL StatefulSetとServiceを生成します。
```bash
kubectl apply -f mysql.yml
```

MySQL Podが正常に実行されるまで待ちます。
```bash
kubectl get pods -w -n querypie | grep mysql
```

##### 3.1.3 データベース初期化

MySQLに接続します。
```bash
kubectl exec -it mysql-0 -n querypie -- mysql -u root -p
# The password is {your-mysql-password} in above example.
```

必要なデータベースを生成します。
```sql
DROP DATABASE IF EXISTS querypie;
DROP DATABASE IF EXISTS querypie_log;
DROP DATABASE IF EXISTS querypie_snapshot;

CREATE database querypie CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
CREATE database querypie_log CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
CREATE database querypie_snapshot CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

GRANT ALL privileges ON querypie.* TO querypie@'%';
GRANT ALL privileges ON querypie_log.* TO querypie@'%';
GRANT ALL privileges ON querypie_snapshot.* TO querypie@'%';

FLUSH PRIVILEGES;
```

MySQLを終了します。
```sql
exit
```

#### 3.2 Redisインストール

RedisはQueryPieのセッションおよびキャッシュ保存庫として使用されます。
以下の内容で`redis.yml`ファイルを生成します。`{your-redis-password}`には顧客社のポリシーに従って異なる値を指定します。
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: querypie
  labels:
    app: redis
spec:
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
        - name: redis
          image: redis:7
          imagePullPolicy: IfNotPresent
          args: ["--requirepass", "{your-redis-password}"]
          ports:
            - containerPort: 6379
              protocol: TCP
          resources:
            limits:
              cpu: "0.1"
              memory: "1Gi"
          volumeMounts:
            - name: redis-data
              mountPath: /data
      restartPolicy: Always
      volumes:
        - name: redis-data
          emptyDir: {}
          # Data is deleted on pod restart. It is OK for cache purposes.
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: querypie
  labels:
    app: redis
spec:
  type: ClusterIP
  selector:
    app: redis
  ports:
    - port: 6379
      targetPort: 6379
      protocol: TCP
```

Redis DeploymentとServiceを生成します。
```bash
kubectl apply -f redis.yml
```

Redis Podが正常に実行されるまで待ちます。
```bash
kubectl get pods -w -n querypie | grep redis
```

### 4. QueryPieインストール

#### 4.1 Secret設定

##### 4.1.1 Container Registry認証情報登録

**Docker Hub使用時**

Docker Hubの公開イメージを使用する場合、このステップをスキップしても構いません。`values.yaml`で`registry: docker.io`に設定すれば認証なしでイメージをダウンロードできます。

**Harbor使用時**

Harborレジストリを使用する場合、以下のコマンドで認証情報を登録します。
```bash
kubectl create secret docker-registry querypie-regcred \
  --docker-server=harbor.chequer.io \
  --docker-username='{harbor-id}' \
  --docker-password='{harbor-pw}' \
  -n querypie
```

##### 4.1.2 QueryPie環境設定

以下の内容で`querypie.env`ファイルを生成します。
環境変数に関するガイドを参照してください：[コンテナ環境変数](../container-environment-variables)
```ini
# Agent Secret (32-character random string)
AGENT_SECRET=01234567890123456789012345678912
KEK=querypie

# QueryPie Meta DB connection info
DB_CATALOG=querypie
DB_HOST=mysql
DB_USERNAME=querypie
DB_PASSWORD={your-mysql-password}
DB_PORT=3306

# QueryPie Log DB connection info
LOG_DB_CATALOG=querypie_log
LOG_DB_HOST=mysql
LOG_DB_USERNAME=querypie
LOG_DB_PASSWORD={your-mysql-password}
LOG_DB_PORT=3306

# QueryPie Snapshot DB connection info
ENG_DB_CATALOG=querypie_snapshot
ENG_DB_HOST=mysql
ENG_DB_USERNAME=querypie
ENG_DB_PASSWORD={your-mysql-password}
ENG_DB_PORT=3306

# Redis connection info
REDIS_NODES=redis:6379
REDIS_PASSWORD={your-redis-password}
```

環境設定ファイルをSecretとして登録します。
```bash
kubectl create secret generic querypie-secret --from-env-file=querypie.env -n querypie
```

#### 4.2 Helm Chart設定

##### 4.2.1 Helm Repository追加

```bash
# Add repository
helm repo add querypie https://chequer-io.github.io/querypie-deployment/helm-chart

# Verify repository list
helm repo list
```

##### 4.2.2 values.yaml設定

以下の内容で`values.yml`ファイルを生成します。

<Callout type="info">
**参考**：以下の例はDocker Hubを使用する事例を基準にしています。
Harbor Registry使用時は`registry: harbor.chequer.io`に変更してください。
インストールする製品バージョンは[製品バージョン](../product-versions)文書を参照して指定してください。
</Callout>
```yaml
# -- appVersion: QueryPie version to install. This is an example value.
# -- Please refer to the Product Versions document for available versions.
appVersion: &version 11.5.1

global:
  image:
    # -- Default registry used for all images
    # For Docker Hub: docker.io
    # For Harbor: harbor.chequer.io
    registry: docker.io
    # -- Default image tags used for all images
    tag: *version
    # -- Default image pull policy for all images
    pullPolicy: IfNotPresent
  # -- Default labels for all resources deployed by the chart
  labels: {}

# -- ServiceAccount for QueryPie and QueryPie tools pods
# It is created for authenticating private image registry and AWS API.
# @default -- {}
serviceAccount:
  labels: {}
  annotations: {}
  # -- The name of the secret used for pulling the QueryPie image from the private registry.
  # For Docker Hub: Set imagePullSecrets to an empty array ([]) or remove this section.
  # For Harbor: Create the querypie-regcred secret and uncomment below.
  imagePullSecrets: []
  # Uncomment below when using Harbor registry:
  # imagePullSecrets:
  #   - name: querypie-regcred

querypie:
  # -- Labels used for QueryPie pods.
  labels: {}
  # -- Annotations used for QueryPie pods.
  annotations: {}
  tolerations: {}
  # -- NodeSelector for QueryPie pods
  nodeSelector: {}
  replicas: 1
  # -- PodManagementPolicy for QueryPie pods. OrderedReady is fine for most cases, but Parallel is also good for large-scale deployments.
  podManagementPolicy: Parallel
  image:
    # -- (string) Registry used for the QueryPie image. If not set, the global registry will be used.
    registry:
    # -- (string) Tag used for the QueryPie image. If not set, the global tag will be used.
    tag:
    # -- (string) PullPolicy used for the QueryPie image. If not set, the global pullPolicy will be used.
    pullPolicy:
    # -- Repository used for the QueryPie image. (required)
    repository: querypie/querypie
  ingress:
    # -- (bool) If true, Ingress resource for QueryPie will be created.
    enabled: true
    labels: {}
    # -- Annotations used for the Ingress resource.
    # It is useful when you want to enable controller-specific feature for the Ingress resource.
    annotations: {}
    # -- (string) Class used for the Ingress resource. If not set, the default class will be used.
    ingressClassName: ""
    # -- Hostname used for the Ingress resource. If not set, every hostname will be accepted.
    host: querypie.querypie.io # Replace with your actual URL
    # -- Extra paths used for the Ingress resource.
    # It is mostly used for redirecting HTTP to HTTPS if the ingress controller does not support redirect by default.

  proxyService:
    # -- Create a service resource for QueryPie Agent connections.
    # Basically, it opens 9000/tcp port for the QueryPie Agent, and 40000~/tcp for the Agentless connections.
    enabled: true
    labels: {}
    # -- Annotations used for the Service resource.
    # It is useful when you want to enable controller-specific feature for the Service resource.
    annotations: {}
    type: LoadBalancer
    loadBalancerClass: ""
    # -- Set the externalTrafficPolicy to Local is recommended for auditing the real client IP address.
    externalTrafficPolicy: "Local"
    # -- SessionAffinity is not required for the QueryPie.
    sessionAffinity: "None"
  updateStrategy:
    # -- The strategy used for updating the QueryPie pods.
    # It is generally recommended to use the RollingUpdate strategy.
    # But if required, you can change it to OnDelete for manual operations.
    type: RollingUpdate
  resources:
    requests:
      cpu: "2000m"
      memory: 16Gi
    limits:
      # -- More than 2 CPU cores are recommended.
      cpu: "2000m"
      # -- More than 16Gi memory is recommended.
      memory: 16Gi
  # -- Logrotator configuration
  # Starting from version 11.3.0, log rotation is built into the main container.
  # The logrotator image is only available on Harbor registry.
  # When using Docker Hub, this must be disabled.
  logrotator:
    enabled: false
    # Uncomment below and set enabled: true when using Harbor registry:
    # image:
    #   repository: querypie/logrotate
    #   tag: latest
  # -- External storage for the QueryPie Object Storage.
  externalStorage:
    # -- Type of the external storage.
    # - none: No external storage.
    # - persistentVolumeClaim: using a single Persistent Volume Claim for all QueryPie pods.
    type: none
    # -- Use a persistent volume claim for the external storage. It will be available if the type is persistentVolumeClaim.
    persistentVolumeClaim:
      # -- Use an existing Persistent Volume Claim for the external storage.
      # If you set this to true, this helm chart will not create a new Persistent Volume Claim.
      useExisting: false
      # -- The name of the existing Persistent Volume Claim to be used.
      claimName: ""
      # -- Metadata of the Persistent Volume Claim.
      metadata:
        annotations: {}
        labels: {}
      # -- Spec of the Persistent Volume Claim.
      spec:
        storageClassName: ""
        resources:
          requests:
            storage: 100Gi
        # -- It is required to have ReadWriteMany access mode on production.
        accessModes:
          - ReadWriteMany
  # -- Extra environment variables used for the QueryPie pods.
  # This is useful for experimental features, debugging, workaround, and so on.
  # for example:
  # API_JVM_HEAPSIZE: '2g' will set the JVM heap size to 2GB.
  extraEnvs: {}

tools:
  image:
    # -- Registry used for the QueryPie tools image. If not set, the global registry will be used.
    repository: querypie/querypie-tools

config:
  # -- External URL that users use to access the QueryPie via web.
  # Specify the scheme, hostname, and port is required.
  externalURL: "https://querypie.querypie.io" # Replace with your actual URL
  secretName: "querypie-secret"

  database:
    querypie:
      # -- The maximum number of connections that QueryPie can use for "metastore" purposes.
      connectionPoolSize: 20

  dac:
    # -- This setting is used to ignore simple queries sent by client tools such as DataGrip.
    # Please refer to the commented-out example below.
    skipCommandConfigData: "{}"
    # skipCommandConfig: |
    #   {
    #     "mysql": [
    #       "^(/\\*.*?\\*/)?\\s*SELECT\\s+@@session\\s*\\.\\s*\\w+\\s*$",
    #       "^(/\\*.*?\\*/)?\\s*SET\\s+session\\s+transaction\\s+\\w+(\\s+\\w+)*\\s*$",
    #       "^(/\\*.*?\\*/)?\\s*SET\\s+net_write_timeout\\s*=\\s*\\d+\\s*$",
    #       "^(/\\*.*?\\*/)?\\s*SELECT\\s+database\\s*\\(\\s*\\)\\s*$",
    #       "^(/\\*.*?\\*/)?\\s*SET\\s+SQL_SELECT_LIMIT\\s*=\\s*\\w+$",
    #       "^SHOW\\s+VARIABLES\\s+LIKE\\s+'aurora\\\\_version'\\s*$",
    #       "^SELECT\\s+version\\s*\\(\\s*\\)\\s*,\\s*@@version_comment\\s*,\\s*database\\s*\\(\\s*\\)\\s*$",
    #       "^SET\\s+autocommit\\s*=\\s*\\d+$",
    #       "^(/\\*.*?\\*/)\\s*SELECT\\s+((@@session\\s*\\.\\s*|@@)\\w+(\\s+AS\\s+\\w+)?(\\s*,\\s*)?)+\\s*$"
    #     ]
    #   }
    # -- The path where the skip command config file will be mounted.
    skipCommandConfigFile: /app/arisa/skip_command_config.json
```

#### 4.3 QueryPieインストール

Helmを使用してQueryPie ACPをインストールします。

QueryPie ACPの[製品バージョン](../product-versions)に従って、Helmバージョンを選択します。

* QueryPie ACP 11.3.0以降：Helm Chart 1.5.0以上の最新バージョンを使用してください。
* QueryPie ACP 11.3.0より前：Helm Chart 1.4.4を使用してください。

この文書のChartバージョンは例として示されたものです。
```bash
helm upgrade --install poc querypie/querypie --version 1.5.0 -n querypie -f values.yaml
```

データベースマイグレーションを実行します。

<Callout type="important">
このステップは必ず実行する必要があります。

実行しないと`Table 'querypie.system_settings' doesn't exist`エラーが発生し、QueryPie Podが正常に起動しません。

このコマンドはMySQLデータベースに必要なスキーマと初期データを作成します。
</Callout>
```bash
kubectl exec -it deployments/poc-querypie-tools -n querypie -- /app/script/migrate.sh runall
```


#### 4.4 インストール確認

Pod状態を確認します。
```bash
kubectl get pods -n querypie
```

ログを確認します。
```bash
kubectl logs pod/poc-querypie-0 -f
```

サービス接続を確認します。
```bash
kubectl port-forward -n querypie statefulsets/poc-querypie 80:80
```

その後、初期設定過程を進行します。

* [ライセンスインストール](../license-installation)
* [インストール後の初期設定](../post-installation-setup)文書を参照して共通設定、製品別設定を進行します。

これで製品インストール過程が完了しました。
お疲れさまでした！

### 5. 問題解決ガイド

#### 5.1 インストール前確認事項

##### 5.1.1 クラスタアクセス権限確認

```bash
# Verify cluster access
kubectl cluster-info

# Check current context
kubectl config current-context

# Verify namespace access permissions
kubectl auth can-i create deployment -n querypie
```

##### 5.1.2 リソース状態確認

```bash
# Check node resource status
kubectl top nodes

# Check available storage classes
kubectl get storageclass
```

#### 5.2 一般的な問題解決

##### 5.2.1 Pod状態確認

```bash
# Check pod status
kubectl get pods -n querypie

# Check pod details
kubectl describe pod <pod-name> -n querypie

# Check pod logs
kubectl logs <pod-name> -n querypie
kubectl logs <pod-name> -n querypie --previous  # Check previous logs if restarted
```

主要問題状態および確認事項：

* `ImagePullBackOff`: Container Registry認証情報確認
    * Docker Hub使用時：`values.yaml`で`registry: docker.io`設定確認、`imagePullSecrets: []`設定確認
    * Harbor使用時：`querypie-regcred` Secret作成有無確認
    * `logrotator`イメージエラー時：`logrotator.enabled: false`設定確認（Docker Hubではlogrotatorイメージが提供されません）
* `Pending`: ノードのリソース不足の有無確認
* `CrashLoopBackOff`: ログを通じてアプリケーションエラー確認
    * `Table 'querypie.system_settings' doesn't exist`エラー：DBマイグレーション未実行 → `migrate.sh runall`コマンド実行が必要

##### 5.2.2 サービス接続確認

```bash
# Check service status
kubectl get svc -n querypie

# Check endpoints
kubectl get endpoints -n querypie

# Test MySQL service connection
kubectl exec -it mysql-0 -- mysql -u querypie -p -h mysql querypie

# Test Redis service connection
kubectl exec -it $(kubectl get pod -l app=redis -o jsonpath='{.items[0].metadata.name}') -- redis-cli -a querypie ping
```

##### 5.2.3 Ingress確認

```bash
# Check ingress status
kubectl get ingress -n querypie

# Check ingress details
kubectl describe ingress -n querypie
```

#### 5.3 リソースモニタリング

```bash
# Check pod CPU/Memory usage
kubectl top pods -n querypie

# Check node CPU/Memory usage
kubectl top nodes

# Check resource limits for a specific pod
kubectl get pod <pod-name> -n querypie -o jsonpath='{.spec.containers[0].resources}'
```

#### 5.4 インストール構成確認

```bash
# Check ConfigMap
kubectl get configmap -n querypie

# Check Secret list
kubectl get secrets -n querypie

# Check PV/PVC status
kubectl get pv
kubectl get pvc -n querypie
```

#### 5.5 サポート依頼時に必要な情報

問題解決が困難な場合、次の情報を収集してサポートチームに問い合わせてください：

##### 5.5.1 環境情報

```bash
# Kubernetes version
kubectl version --short

# Node information
kubectl get nodes -o wide

# Helm version
helm version
```

##### 5.5.2 QueryPie状態情報

```bash
# Helm deployment status
helm status poc -n querypie

# Pod details
kubectl describe pod/poc-querypie-0 -n querypie

# Recent events list
kubectl get events -n querypie --sort-by='.lastTimestamp'
```

##### 5.5.3 ログ情報

```bash
# Save QueryPie logs
kubectl logs pod/poc-querypie-0 -n querypie > querypie.log

# Save related component logs
kubectl logs mysql-0 > mysql.log
kubectl logs $(kubectl get pod -l app=redis -o jsonpath='{.items[0].metadata.name}') > redis.log
```

### 6. 参考資料

* [Amazon EKS Workshop](https://www.eksworkshop.com)
* [Amazon EKS文書](https://docs.aws.amazon.com/eks/)
* [Kubernetes公式文書](https://kubernetes.io/docs/)
