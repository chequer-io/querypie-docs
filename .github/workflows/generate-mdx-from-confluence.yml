name: Generate MDX from Confluence

on:
  workflow_dispatch:
    inputs:
      use_local:
        description: 'Use local files (--local option)'
        required: false
        default: true
        type: boolean
      use_attachments:
        description: 'Download attachments from Confluence pages (--attachments option)'
        required: false
        default: false
        type: boolean

jobs:
  generate-mdx:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 전체 히스토리 가져오기 (git status를 위해 필요)

      - name: Workflow Options
        run: |
          echo "Use local files (--local): ${{ inputs.use_local }}"
          echo "Download attachments (--attachments): ${{ inputs.use_attachments }}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Pull latest Docker image
        working-directory: ./confluence-mdx
        run: |
          set -o xtrace
          docker --version
          docker compose version
          # 플랫폼을 명시적으로 지정하여 아키텍처 불일치 오류 방지
          DOCKER_DEFAULT_PLATFORM=linux/amd64 docker compose --progress=quiet pull confluence-mdx

      - name: Generate MDX files
        working-directory: ./confluence-mdx
        run: |
          # 옵션 구성
          OPTIONS=""
          if [[ "${{ inputs.use_local }}" == "true" ]]; then
            OPTIONS="$OPTIONS --local"
          fi
          if [[ "${{ inputs.use_attachments }}" == "true" ]]; then
            OPTIONS="$OPTIONS --attachments"
          fi
          set -o xtrace
          touch .env # Create an empty .env to prevent missing .env error.
          docker compose run --rm confluence-mdx full $OPTIONS

      - name: Check for changes
        run: |
          echo "## Changed Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # git status로 변경된 파일 확인
          if [ -n "$(git status --porcelain)" ]; then
            echo "### Modified Files" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            git status --short >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          
            # target 디렉토리 관련 변경사항만 별도로 표시
            echo "### Changes in target directory" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            git status --short confluence-mdx/target/ src/content/ public/ 2>/dev/null || echo "No changes in target-related directories" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          
            # 전체 변경사항 통계
            echo "### Change Statistics" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            git diff --stat HEAD >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No changes detected." >> $GITHUB_STEP_SUMMARY
          fi
          
          # 콘솔에도 출력
          echo "=== Git Status ==="
          git status
          
          echo ""
          echo "=== Changes in target-related directories ==="
          git status --short confluence-mdx/target/ src/content/ public/ 2>/dev/null || echo "No changes in target-related directories"
          
          echo ""
          echo "=== Change Statistics ==="
          git diff --stat HEAD || echo "No changes to show"

