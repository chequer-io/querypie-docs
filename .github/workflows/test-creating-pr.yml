name: Test creating PR

on:
  workflow_dispatch:
    inputs:
      use_local:
        description: 'Use local files (--local option)'
        required: false
        default: false
        type: boolean
      use_attachments:
        description: 'Download attachments from Confluence pages (--attachments option)'
        required: false
        default: false
        type: boolean

jobs:
  generate-mdx:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 전체 히스토리 가져오기 (git status를 위해 필요)
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Workflow Options
        run: |
          echo "Use local files (--local): ${{ inputs.use_local }}"
          echo "Download attachments (--attachments): ${{ inputs.use_attachments }}"

      - name: Modify MDX files
        working-directory: ./confluence-mdx
        run: |
          # 옵션 구성
          OPTIONS=""
          if [[ "${{ inputs.use_local }}" == "true" ]]; then
            OPTIONS="$OPTIONS --local"
          fi
          if [[ "${{ inputs.use_attachments }}" == "true" ]]; then
            OPTIONS="$OPTIONS --attachments"
          fi
          set -o xtrace
          echo $OPTIONS >>target/ko/index.mdx
          echo $OPTIONS >>target/en/index.mdx
          echo $OPTIONS >>target/ja/index.mdx

      - name: Check for changes
        run: |
          echo "=== Git Status ==="
          git status

      - name: Verify GitHub CLI
        run: |
          gh --version || (echo "GitHub CLI not available" && exit 1)

      - name: Create Pull Request for src/content changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          # Git 사용자 설정
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # gh CLI 인증 설정
          echo "$GITHUB_TOKEN" | gh auth login --with-token
          
          # src/content/ 변경사항 확인
          # git status --porcelain 출력 형식: " M file" (unstaged), "M  file" (staged), "MM file" (both)
          CHANGES_STATUS=$(git status --short src/content/ || echo "")
          
          if [[ -z "$CHANGES_STATUS" ]] || ! echo "$CHANGES_STATUS" | grep -q "[AM]"; then
            echo "No changes in src/content/ directory"
            exit 0
          fi
          
          # 브랜치 이름 생성 (타임스탬프)
          BRANCH_NAME="test/mdx-updates-$(date +%Y%m%d-%H%M%S)"
          
          # 브랜치 생성 및 체크아웃
          git checkout -b "$BRANCH_NAME"
          
          # src/content/ 변경사항만 스테이징
          git add src/content/
          
          # 스테이징된 변경사항 확인
          STAGED_FILES=$(git diff --cached --name-only)
          if [[ -z "$STAGED_FILES" ]]; then
            echo "No staged changes in src/content/"
            exit 0
          fi
          
          # 변경사항 통계 (스테이징 후에 확인)
          CHANGES_STAT=$(git diff --cached --stat HEAD || echo "")
          
          # 커밋
          git commit -m "test: Updates from Confluence (do not merge)"
          
          # 브랜치 푸시 (PR 생성 전에 필요)
          if ! git push -u origin "$BRANCH_NAME"; then
            echo "Failed to push branch $BRANCH_NAME"
            exit 1
          fi
          
          # PR Description 생성
          PR_BODY=$(printf '%s\n\n%s\n\n%s\n\n%s\n' \
            "=== Changes ===" \
            "$CHANGES_STATUS" \
            "=== Change Statistics ===" \
            "$CHANGES_STAT")
          
          # PR 생성
          if ! gh pr create \
            --title "test: Creating PR, do not merge" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME"; then
            echo "Failed to create PR. Branch $BRANCH_NAME has been pushed."
            exit 1
          fi
          
          echo "Pull request created successfully for branch $BRANCH_NAME"

