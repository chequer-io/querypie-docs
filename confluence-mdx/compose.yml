# ============================================================================
# Confluence-MDX Container Compose Configuration and Usage Guide
# ============================================================================
#
# Quick Start:
#   1. Build image: docker compose --progress=plain build
#      (Use --progress=plain to see raw command output without Docker formatting)
#   2. Show help: docker compose run --rm confluence-mdx help
#   3. Full workflow: docker compose run --rm confluence-mdx full
#
# Environment Variables (.env file):
#   ATLASSIAN_USERNAME=your-email@example.com
#   ATLASSIAN_API_TOKEN=your-api-token
#
# Main Commands:
#   - Full workflow for recent updates: docker compose run --rm confluence-mdx full
#   - Full workflow with attachments: docker compose run --rm confluence-mdx full --remote --attachments
#   - Full workflow with local files (no API calls): docker compose run --rm confluence-mdx full --local
#   - Collect data: docker compose run --rm confluence-mdx fetch_cli.py --attachments
#   - Convert all pages: docker compose run --rm confluence-mdx convert_all.py
#   - Interactive shell: docker compose run --rm confluence-mdx bash
#
# Container Commands (without compose):
#   - Build: docker build --platform linux/amd64 --progress=plain -t docker.io/querypie/confluence-mdx:latest .
#     (Use --progress=plain to see raw command output without Docker formatting)
#   - Run: docker run docker.io/querypie/confluence-mdx:latest help
#   - Push: docker push docker.io/querypie/confluence-mdx:latest
#
# Notes:
#   - Data in var/ directory is included in the image, so image rebuild is required when updating
#   - target/ directory is volume mounted and persisted on the host
#   - Network connection is required for Confluence API calls
#
# ============================================================================

services:
  confluence-mdx:
    platform: linux/amd64  # GitHub Actions runner는 x86_64 아키텍처 사용
    build:
      context: .
      dockerfile: Dockerfile
    image: docker.io/querypie/confluence-mdx:latest
    container_name: confluence-mdx
    working_dir: /workdir
    # Load environment variables from .env file (if it exists)
    # Create .env file with: ATLASSIAN_USERNAME=your-email@example.com and ATLASSIAN_API_TOKEN=your-token
    env_file:
      - .env
    volumes:
      # Use translation file from host
      - ./etc/korean-titles-translations.txt:/workdir/etc/korean-titles-translations.txt
      # Mount files in var to host
      - ./var/pages.yaml:/workdir/var/pages.yaml
      - ./var/list.txt:/workdir/var/list.txt
      # Mount output directories to host (matching symlink structure in target/)
      # target/ko -> ../../src/content/ko
      - ../src/content/ko:/workdir/target/ko
      # target/en -> ../../src/content/en
      - ../src/content/en:/workdir/target/en
      # target/ja -> ../../src/content/ja
      - ../src/content/ja:/workdir/target/ja
      # target/public -> ../../public
      - ../public:/workdir/target/public
      # Mount log files to host (optional)
      - ./logs:/workdir/logs
    # Default command is 'help' (modify command section to override)
    command: ["help"]
    # Uncomment below to keep container running after exit
    # restart: "no"
